humhub.module("mail.ConversationView",function(r,t,h){const f={entry:".mail-conversation-entry",entryList:".conversation-entry-list",lastMessageButton:".to-last-message",lastMessageButtonContainer:".to-end-button-container",startPoint:".conversation-stream-start"};var s=t("ui.widget").Widget,a=t("ui.loader"),l=t("client"),n=t("ui.additions"),e=t("util.object"),o=t("mail.notification"),g=t("ui.view"),i=t("mail.mobile"),c=s.extend();c.prototype.init=function(){n.observe(this.$);var e=this;window.onresize=function(t){e.updateSize(!0)},g.isSmall()||g.isMedium()||this.reload(),this.$.on("mouseenter",f.entry,function(){h(this).find(".conversation-menu").show()}).on("mouseleave",f.entry,function(){h(this).find(".conversation-menu").hide()}),this.$.on("click",f.lastMessageButton,function(t){e.toLastMessage(t)}),this.detectOpenedDialog()},c.prototype.loader=function(t){!1!==t?a.set(this.$):a.reset(this.$)},c.prototype.markSeen=function(t){l.post(this.options.markSeenUrl,{data:{id:t}}).then(function(t){e.isDefined(t.messageCount)&&o.setMailMessageCount(t.messageCount)}).catch(function(t){r.log.error(t)})},c.prototype.loadUpdate=function(){var t=this.$.find(".mail-conversation-entry:not(.own):last").data("entry-id"),t={id:this.getActiveMessageId(),from:t},e=this;l.get(this.options.loadUpdateUrl,{data:t}).then(function(t){t.html&&h(t.html).each(function(){e.appendEntry(h(this))})})},c.prototype.reply=function(e){var n=this;l.submit(e).then(function(t){t.success?n.appendEntry(t.content).then(function(){n.$.find(".time").timeago();var t=n.getReplyRichtext();t&&t.$.trigger("clear"),n.scrollToBottom(),g.isSmall()||g.isMedium()||n.focus(),s.instance("#inbox").updateEntries([n.getActiveMessageId()]),s.instance(".reply-container").detachReply(),n.setLivePollInterval()}):r.log.error(t,!0)}).catch(function(t){r.log.error(t,!0)}).finally(function(t){a.reset(h(".reply-button")),e.finish()})},c.prototype.setLivePollInterval=function(){t("live").setDelay(5)},c.prototype.getReplyRichtext=function(){return s.instance(this.$.find(".ProsemirrorEditor"))},c.prototype.focus=function(t){if(g.isSmall()||g.isMedium())return Promise.resolve();var e=this.getReplyRichtext();e&&e.focus()},c.prototype.canLoadMore=function(){return!this.options.isLast},c.prototype.reload=function(){this.getActiveMessageId()&&this.loadMessage(this.getActiveMessageId())},c.prototype.addUser=function(t){var e=this;l.submit(t).then(function(t){t.result?e.$.find("#mail-conversation-header").html(t.result):t.error&&r.log.error(t,!0)}).catch(function(t){r.log.error(t,!0)})},c.prototype.appendEntry=function(t){var n=this,t=h(t);if(n.$.find('[data-entry-id="'+t.data("entryId")+'"]').length)return Promise.resolve();var o=t.not("script, link").filter(function(){return 1===this.nodeType});return o.css("opacity",0),this.getListNode().append(t),new Promise(function(t,e){o.css("opacity",1).fadeIn("fast",function(){n.onUpdate(),setTimeout(function(){n.scrollToBottom()},100),t()})})},c.prototype.loadMessage=function(n){(g.isSmall()||g.isMedium())&&h(".messages").addClass("shown");var o=e.isNumber(n)?n:n.$trigger.data("message-id"),i=this;this.loader(),l.get(this.options.loadMessageUrl,{data:{id:o}}).then(function(t){var e;return i.setActiveMessageId(o),i.options.isLast=!1,i.options.hasAfter=!1,s.instance("#inbox").updateActiveItem(),n.$trigger&&history&&history.replaceState&&((e=n.$trigger.data("action-url"))&&history.replaceState(null,null,e)),i.$.css("visibility","hidden"),i.updateContent(t.html)}).then(function(){return i.initScroll()}).catch(function(t){r.log.error(t,!0)}).finally(function(){i.scrollToBottom(),i.loader(!1),i.$.css("visibility","visible"),i.initReplyRichText();const t=h(".chat-title-wrap");var e=t.children("span");i.makeScrollable(t,e);const n=h(".chat-occupation-wrap"),o=n.children(".rocketcore-user-occupation");n.on("mouseenter",function(){i.makeScrollable(n,o,!1)}),n.on("mouseleave").on("mouseleave",function(){n.animate({scrollLeft:0},3500)})})},c.prototype.makeScrollable=function(t,e,n=!0,o=1500,i=3500){if(t.innerWidth()<e.innerWidth()){const r=t.offset().left,s=()=>{setTimeout(()=>{t.animate({scrollLeft:r},i,()=>{setTimeout(()=>t.animate({scrollLeft:0},i,function(){n&&s()}),o)})},o)};s()}},c.prototype.initReplyRichText=function(){var t,e,n=this;window.ResizeObserver&&(t=new ResizeObserver(function(t){n.updateSize(n.isScrolledToBottom(100))}),(e=n.getReplyRichtext())&&t.observe(e.$[0])),n.focus()},c.prototype.isScrolledToBottom=function(t){if(!this.getListNode().length)return!1;t=t||0;var e=this.getListNode()[0];return e.scrollHeight-e.offsetHeight-e.scrollTop<=t},c.prototype.initScroll=function(t=!0){var o,i,n;if(window.IntersectionObserver)return i=(o=this).getListNode(),n=new IntersectionObserver(function(t){var e=t.length&&t[0].isIntersecting;if(e&&"conversation-stream-end"===t[0].target.className&&!o.preventScrollLoading()){a.prepend(i);const n=i.find(f.entry+":first").data("entry-id");o.loadMore().finally(function(){a.reset(i),o.scrollToMessage(n,0,"top")})}else e&&"conversation-stream-start"===t[0].target.className&&!o.preventScrollLoadingAfter()&&(a.append(i),o.loadMore("new").finally(function(){a.reset(i)}))},{root:i[0],rootMargin:"50px"}),this.assureScroll(t).then(function(){g.isLarge()&&i.niceScroll({cursorwidth:"7",cursorborder:"",cursorcolor:"#555",cursoropacitymax:"0.2",nativeparentscrolling:!1,railpadding:{top:0,right:0,left:0,bottom:0}});var t=h('<div class="conversation-stream-end"></div>'),e=h('<div class="conversation-stream-start"></div>');n.observe(t[0]),n.observe(e[0]),i.prepend(t),i.append(e),i.scroll(function(){var t=i.get(0).scrollHeight-i.outerHeight();i.scrollTop()>t-200?o.hideToEndButton():o.showToEndButton()})})},c.prototype.loadMore=function(n="old"){var o=this,t={id:this.getActiveMessageId()};return"old"===n?t.from=this.$.find(".mail-conversation-entry:first").data("entryId"):"new"===n&&(t.to=this.$.find(".mail-conversation-entry:last").data("entryId")),l.get(this.options.loadMoreUrl,{data:t}).then(function(t){var e;if(t.result)if("old"===n)e=h(t.result).hide(),o.$.find(".conversation-entry-list").find(".conversation-stream-end").after(e),e.fadeIn();else{if("new"!==n)return o.options.hasAfter=!1,o.options.isLast=t.isLast,o.updateEntriesList(t.result,"down");e=h(t.result).hide(),o.$.find(".conversation-entry-list").find(".conversation-stream-start").before(e),e.fadeIn()}return"new"===n?o.options.hasAfter=t.result&&!t.isLast:o.options.isLast=!t.result||t.isLast,Promise.resolve()}).catch(function(t){r.log.error(t,!0)})},c.prototype.preventScrollLoading=function(){return this.scrollLock||!this.canLoadMore()},c.prototype.canLoadMore=function(){return!this.options.isLast},c.prototype.assureScroll=function(t){var e=this,n=this.$.find(".conversation-entry-list");return n[0].offsetHeight>=n[0].scrollHeight&&this.canLoadMore()?this.loadMore().then(function(){return e.assureScroll()}).catch(function(){return Promise.resolve()}):t?e.scrollToBottom():Promise.resolve()},c.prototype.updateContent=function(e){return new Promise(t=>{this.$.html(e).promise().done(()=>t())})},c.prototype.getActiveMessageId=function(){return this.options.messageId},c.prototype.setActiveMessageId=function(t){this.options.messageId=t},c.prototype.scrollToBottom=function(){var n=this;return new Promise(function(e){setTimeout(function(){n.$.imagesLoaded(function(){var t=n.getListNode();t.length&&n.updateSize(!1).then(function(){t.scrollTop(t[0].scrollHeight),setTimeout(()=>{if(!n.isScrolledToBottom(100))return n.scrollToBottom()},100),e()})})})})},c.prototype.updateSize=function(i){var r=this;return new Promise(function(o){setTimeout(function(){var t,e,n=r.$.find(".conversation-entry-list");n.length&&(t=(t=r.getReplyRichtext())?t.$.innerHeight():0,n.css("margin-bottom",t+5+"px"),e=r.$.find(".conversation-entry-list").offset().top,e=window.innerHeight-e-t-(g.isSmall()||g.isMedium()?20:30)+"px",n.css("height",e),n.css("max-height",e),!1!==i&&r.scrollToBottom(),o())},100)})},c.prototype.getListNode=function(){return this.$.find(".conversation-entry-list")},c.prototype.onUpdate=function(){g.isLarge()&&this.getListNode().getNiceScroll().resize()},c.prototype.isLastMessageMine=function(){return this.$.find(".mail-conversation-entry").last().hasClass("own")};c.prototype.close=function(){this.setActiveMessageId(null),s.instance("#inbox").updateActiveItem(),this.$.html("");{const t=new URL(window.location);t.searchParams.delete("id"),window.history.pushState({},"",t)}(g.isSmall()||g.isMedium())&&i.closeConversation()},c.prototype.detectOpenedDialog=function(){if(g.isSmall()||g.isMedium()){const e=new URLSearchParams(window.location.search);var t;e.has("id")&&(t=e.get("id"),h(".messages").addClass("shown"),this.loadMessage(parseInt(t)))}},c.prototype.getMessageContainer=function(t){return h(f.entry+`[data-entry-id="${t}"]`)},c.prototype.scrollToMessage=function(t,e=400,n="middle"){const o=function(t,e,n){return"top"===n?-33:"bottom"===n?-t+e.height()+90:-t/2+e.height()/2+60};var i=this.getMessageContainer(t);if(!i.length)return r=this.getListNode().find(f.entry+":nth(3)").data("entry-id"),this.scrollToMessage(r,2e3,"top"),this.loadAroundEntries(this.getActiveMessageId(),t).then(()=>this.scrollToMessage(t));if(g.isSmall()||g.isMedium()){var r=i;const l=h(f.entryList);var s=l.scrollTop(),a=o(l.get(0).clientHeight,r,n);const c=s+r.position().top+a;return new Promise(t=>{l.animate({scrollTop:c},e,()=>{t()})})}{s=i;const d=h(f.entryList),u=d.getNiceScroll(0);a=u.getScrollTop(),i=o(u.cursorwidth,s,n);const p=a+s.position().top+i;return new Promise(t=>{d.animate({scrollTop:p},e,()=>{t()})});return}},c.prototype.highlightMessage=function(t){const e=this.getMessageContainer(t);var n;e.addClass("highlight"),n=4e3,new Promise(t=>setTimeout(t,n)).then(()=>{e.removeClass("highlight")})},c.prototype.loadAroundEntries=function(t,e){return this.options.isLast=!0,this.options.hasAfter=!1,l.get(this.options.aroundEntriesUrl,{data:{id:t,entryId:e}}).then(t=>(this.options.isLast=!t.hasBefore,this.options.hasAfter=t.hasAfter,this.updateEntriesList(t.result))).catch(t=>{r.log.error(t,!0)})},c.prototype.updateEntriesList=function(e,o="up",i=600){return new Promise(t=>{let n;"up"===o?(n=this.getListNode().find(f.entry+":first"),h(e).insertBefore(n)):(n=this.getListNode().find(f.entry+":last"),h(e).insertAfter(n)),setTimeout(()=>{this.getListNode().find(f.entry).each((t,e)=>{("up"===o?h(e).data("entry-id")>=n.data("entry-id"):h(e).data("entry-id")<=n.data("entry-id"))&&h(e).remove()}),t()},i)})},c.prototype.preventScrollLoadingAfter=function(){return this.scrollLock||!this.canLoadMoreAfter()},c.prototype.canLoadMoreAfter=function(){return this.options.hasAfter},c.prototype.toLastMessage=function(t){if(t.preventDefault(),!this.options.hasAfter)return t=this.$.find(".mail-conversation-entry:last").data("entryId"),this.scrollToMessage(t,400,"bottom");t=this.getListNode().find(f.entry+":nth-last-child(4)").data("entry-id");return this.scrollToMessage(t,2e3,"bottom"),this.loadMore("last").then(()=>{this.scrollToBottom()})},c.prototype.hideToEndButton=function(){this.$.find(f.lastMessageButtonContainer).fadeOut()},c.prototype.showToEndButton=function(){this.$.find(f.lastMessageButtonContainer).fadeIn()},r.export=c}),humhub.module("mail.ConversationEntry",function(t,e,o){e=e("ui.widget").Widget.extend();e.prototype.replace=function(t){var e=this,n=o(t).hide();this.$.fadeOut(function(){o(this).replaceWith(n),e.$=n,e.$.fadeIn("slow")})},e.prototype.remove=function(){this.$.fadeToggle("slow",function(){o(this).remove()})},t.export=e}),humhub.module("mail.inbox",function(i,t,r){var n=t("ui.widget").Widget,e=t("ui.filter").Filter,o=t("ui.view"),s=t("ui.loader"),a=t("client"),t=e.extend(),e=(t.prototype.triggerChange=function(){this.super("triggerChange"),this.updateFilterCount()},t.prototype.updateFilterCount=function(){var t=this.getActiveFilterCount(),e=this.$.find("#conversation-filter-link"),n=e.find(".filterCount");t?(n=n.length?n:r('<small class="filterCount"></small>').insertBefore(e.find(".caret"))).html(" <b>("+t+")</b> "):n.length&&n.remove()},n.extend());e.prototype.init=function(){this.filter=n.instance("#mail-filter-root"),this.initScroll();var t=this;this.filter.off("afterChange.inbox").on("afterChange.inbox",function(){t.reload().then(function(){t.updateActiveItem()})}),o.isLarge()&&this.$.niceScroll({cursorwidth:"7",cursorborder:"",cursorcolor:"#555",cursoropacitymax:"0.2",nativeparentscrolling:!1,railpadding:{top:0,right:3,left:0,bottom:0}}),this.$.on("click",".entry",function(){t.$.find(".entry").removeClass("selected"),r(this).addClass("selected")})},e.prototype.updateEntries=function(t){var n=this;t.length&&a.get(this.options.updateEntriesUrl,{data:{ids:t}}).then(function(t){t.result&&(r.each(t.result,function(t,e){t=n.getEntry(t);t.length?t.replaceWith(e):r(e).prependTo(n.$)}),n.updateActiveItem())}).catch(function(t){i.log.error(t)})},e.prototype.getEntry=function(t){return this.$.find('[data-message-preview="'+t+'"]')},e.prototype.initScroll=function(){var t,e,n;window.IntersectionObserver&&(t=r('<div class="inbox-stream-end"></div>'),this.$.append(t),e=this,n=new IntersectionObserver(function(t){e.preventScrollLoading()||t.length&&t[0].isIntersecting&&(s.append(e.$),e.loadMore().finally(function(){s.reset(e.$)}))},{root:this.$[0],rootMargin:"50px"}),this.assureScroll().then(function(){n.observe(t[0])})),r(".filterInput").off("select2:close").on("select2:close",function(t){var e="scroll.select2";r(t.target).parents().off(e),r(window).off(e)})},e.prototype.assureScroll=function(){var t=this;return this.$[0].offsetHeight>=this.$[0].scrollHeight&&this.canLoadMore()?(this.scrollLock=!0,this.loadMore().then(function(){return t.assureScroll()}).catch(function(){return Promise.resolve()})):Promise.resolve()},e.prototype.loadMore=function(){var o=this;return new Promise(function(e,n){var t=o.filter.getFilterMap();t.from=o.getLastMessageId(),a.get(o.options.loadMoreUrl,{data:t}).then(function(t){t.result&&(r(t.result).insertBefore(".inbox-stream-end"),o.$.find(".inbox-stream-end").append()),o.options.isLast=!t.result||t.isLast,o.updateActiveItem(),e()}).catch(function(t){i.log.error(t,!0),n()}).finally(function(){o.scrollLock=!1})})},e.prototype.preventScrollLoading=function(){return this.scrollLock||!this.canLoadMore()},e.prototype.canLoadMore=function(){return!this.options.isLast},e.prototype.getReloadOptions=function(){return{data:this.filter.getFilterMap()}},e.prototype.updateActiveItem=function(){var t;null!==n.instance("#mail-conversation-root")&&(t=n.instance("#mail-conversation-root").getActiveMessageId(),this.$.find(".entry").removeClass("selected"),this.$.find(".entry.selected").find(".new-message-badge").hide(),this.$.find(".entry").removeClass("selected"),(t=this.$.find('[data-message-preview="'+t+'"]')).length&&(t.removeClass("unread").addClass("selected").find(".new-message-badge").hide(),t.find(".chat-count").hide()))},e.prototype.getFirstMessageId=function(){return this.$.find(".entry:first").data("messagePreview")},e.prototype.getLastMessageId=function(){return this.$.find(".entry:last").data("messagePreview")},e.prototype.hide=function(){var e=r(".inbox-wrapper");return new Promise(function(t){o.isSmall()&&e.length&&r("#mail-conversation-root").length&&n.instance("#mail-conversation-root").updateSize(),t()})},e.prototype.show=function(){var e=r(".inbox-wrapper");return new Promise(function(t){o.isSmall()&&e.length&&r("#mail-conversation-root").length&&n.instance("#mail-conversation-root").updateSize(),t()})};i.export({ConversationList:e,Filter:t,setTagFilter:function(t){n.instance("#inbox").show().then(function(){r("#mail-filter-menu").collapse("show"),n.instance("#inbox-tag-picker").setSelection([{id:t.$trigger.data("tagId"),text:t.$trigger.data("tagName"),image:t.$trigger.data("tagImage")}])})},toggleInbox:function(){}})}),humhub.module("mail.conversation",function(o,t,r){function i(t){return s.instance('.mail-conversation-entry[data-entry-id="'+t+'"]')}var s=t("ui.widget").Widget,a=t("ui.modal"),n=t("client"),e=t("event"),l=t("mail.notification"),c=t("user");o.export({init:function(){e.on("humhub:modules:mail:live:NewUserMessage",function(t,e){var n,o,i;r("#inbox").length&&(n=s.instance("#mail-conversation-root"),o=!1,i=[],e.forEach(function(t){var e=t.data.user_guid==c.guid();i.push(t.data.message_id),!o&&n&&n.options.messageId==t.data.message_id?(n.loadUpdate(),o=!0,n.markSeen(t.data.message_id)):!e&&n&&(e=t.data.message_id,(t=r("#mail-conversation-overview").find('[data-message-preview="'+e+'"]')).is(".selected")||t.find(".new-message-badge").show())}),s.instance("#inbox").updateEntries(i))}).on("humhub:modules:mail:live:UserMessageDeleted",function(t,e,n){r("#inbox").length&&e.forEach(function(t){var e=i(t.data.entry_id);e&&e.remove(),l.setMailMessageCount(t.data.count)})})},leave:function(t){n.post(t).then(function(t){t.redirect&&n.pjax.redirect(t.redirect)}).catch(function(t){o.log.error(t,!0)})},submitEditEntry:function(n){a.submit(n).then(function(t){var e;t.success?(e=i(n.$trigger.data("entry-id")))&&setTimeout(function(){e.replace(t.content)},300):o.log.error(null,!0)}).catch(function(t){o.log.error(t,!0)})},deleteEntry:function(t){var e=i(t.$trigger.data("entry-id"));e?n.post(e.options.deleteUrl).then(function(t){a.global.close(),t.success&&setTimeout(function(){e.remove()},1e3)}).catch(function(t){o.log.error(t,!0)}):o.log.error(null,!0)}})}),humhub.module("mail.reply",function(i,t,r){var s={messagesRoot:"#mail-conversation-root",replyButton:".rocketmailreply-btn",convEntry:".mail-conversation-entry",convEntryContent:".mail-conversation-entry .content",convEntriesList:".conversation-entry-list",mailAddonRoot:".rocketcore-mail-addon-container",mailAddonRootEntry:".rocketcore-mail-addon-entry",replyBtn:".rocketmailreply-btn",editor:".ProsemirrorEditor",messageDom:"[data-ui-richtext]",avatar:".avatar img",reply:".reply-container",replyAuthor:".reply-author",replyText:".reply-text",replyId:"#replyform-replyid",replyDetachButton:"#reply-detach"};const n="mail:reply:changed";function e(t=[]){if(t.length<=2)return!1;(l||r(s.messagesRoot)).find(s.convEntryContent).each(function(t,e){e=r(e);if(!!e.closest(".mail-conversation-entry").find(".profile-disable").length)return!1;if(e.find(s.mailAddonRoot).length)return!0;var n=m(),o=g();n.appendChild(o),e.append(n)})}var o,a,l,c=t("ui.widget").Widget,d=t("ui.richtext"),u=t("util").url,t=c.extend(),p=(t.prototype.init=function(){this.api=o,this.editor=this._getEditor()},t.prototype.handle=function(){const t=c.instance(s.reply);var e=this.getMessageId();t.attachReply(e),this.focusEditor()},t.prototype.focusEditor=function(){var t=this.api.state.Selection.atEnd(this.editor.view.state.doc),t=this.editor.view.state.tr.setSelection(t);this.editor.view.focus(),this.editor.view.dispatch(t.scrollIntoView())},t.prototype._getEditor=function(){return c.instance(r(s.messagesRoot).find(s.editor)).editor},t.prototype.getMessageId=function(){return this.$.closest(s.convEntry).data("entry-id")},c.extend()),h=(p.prototype.init=function(){this.api=o,this.editor=c.instance(r(s.editor)).editor,this.domParser=this.api.model.DOMParser.fromSchema(this.editor.view.state.schema),this.initDetachButton()},p.prototype.attachReply=function(t){var e=this.getMessageContainer(t);e.length?(e=this.getMessageInfo(e),this.setReplyAuthor(e.author),this.setReplyText(e.text),this.setReplyId(e.id),this.showReply(),r(document).trigger(n,[e.id,e.author,e.text])):i.log.error("Message container not found",t)},p.prototype.detachReply=function(){var t=this.getReplyId();this.setReplyAuthor(""),this.setReplyText(""),this.setReplyId(""),this.hideReply(),r(document).trigger(n,[t,"",""])},p.prototype.getMessageId=function(t){return t.data("entry-id")},p.prototype.getMessageAuthor=function(t){return t.find(s.avatar).data("original-title")},p.prototype.getMessageInfo=function(t){return{id:this.getMessageId(t),author:this.getMessageAuthor(t),text:this.getMessageTextCut(t)}},p.prototype._getDomNode=function(t){return t.find(s.messageDom)[0]},p.prototype.getNodesContent=function(t){return this.domParser.parse(this._getDomNode(t))},p.prototype.stripBlockquoteFromBeginning=function(t){return t.content.size&&"blockquote"===t.content.content[0].type.name?t.cut(t.content.content[0].nodeSize):t},p.prototype.getMessageText=function(t){var e=this.stripBlockquoteFromBeginning(this.getNodesContent(t));let n="";for(let t=0;t<e.content.childCount;t++)e.content.content[t].isTextblock&&e.content.content[t].textContent.length&&(n=(n+=""!==n?" ":"")+e.content.content[t].textContent);return n},p.prototype.getMessageTextCut=function(t){const e=this.getMessageText(t);return e.length<=40?e:e.slice(0,40)+"..."},p.prototype.getMessageContainer=function(t){return r(s.convEntry+`[data-entry-id="${t}"]`)},p.prototype.getReplyAuthor=function(){return r(s.replyAuthor).text()},p.prototype.getReplyText=function(){return r(s.replyText).text()},p.prototype.getReplyId=function(){return r(s.replyId).val()},p.prototype.setReplyAuthor=function(t){r(s.replyAuthor).text(t)},p.prototype.setReplyText=function(t){r(s.replyText).text(t)},p.prototype.setReplyId=function(t){r(s.replyId).val(t)},p.prototype.showReply=function(){r(s.reply).css("display","flex")},p.prototype.hideReply=function(){r(s.reply).css("display","none")},p.prototype.initDetachButton=function(){r(s.replyDetachButton).click(t=>{t.preventDefault(),this.detachReply(),this.focusEditor()})},!(p.prototype.focusEditor=function(){const t=c.instance(r(s.editor));t.focus()})),f=function(t){t.preventDefault(),c.instance(this).handle()},g=function(){var t=document.createElement("div"),e=document.createElement("button"),n=document.createElement("span"),o=i.text("reply")||"Reply";return n.innerText=o,t.classList.add(s.mailAddonRootEntry.replace(".","")),e.classList.add(s.replyButton.replace(".","")),e.dataset.uiWidget="mail.reply.MailReplyButton",e.title=o,e.appendChild(n),t.appendChild(e),t},m=function(){var t=document.createElement("div");return t.classList.add(s.mailAddonRoot.replace(".","")),t};i.export({initOnPjaxLoad:!0,init:function(){return i.log.debug("Trying to initialize"),(t=u.getUrlParameter("r"))&&-1<decodeURIComponent(t).indexOf("mail/mail")||-1<location.pathname.indexOf("mail/mail")?h?(i.log.debug("Already initialized"),!0):(o=d.prosemirror.api,l=r(s.messagesRoot),(a=a||new MutationObserver(e)).observe(l[0],{childList:!0,subtree:!0}),r(document).on("click",s.replyButton,f),h=!0,void i.log.debug("Module initialized")):h?(i.log.debug("Module was initialized before, but the current page is not managed"),a.disconnect(),h=!1,r(document).off("click",s.replyButton,f),void i.log.debug("Module disconnected")):(i.log.debug("Can't initialize - the current page is not managed"),!1);var t},initReplyButton:e,scrollToOriginalMessage:function(t){const e=t.params.messageId,n=c.instance(s.messagesRoot);n.scrollToMessage(e).then(()=>{n.highlightMessage(e)})},MailReply:p,MailReplyButton:t})}),humhub.module("mail.draft",function(n,t,r){var e={messagesRoot:"#mail-conversation-root",editor:".ProsemirrorEditor",selectedConversation:".messagePreviewEntry.selected",submitButton:".reply-button"},o="mail:draft:changed",s="mail:reply:changed";var l=t("ui.widget").Widget,a=t("util").url,c=t("ui.richtext");function d(t){this.key=t,this.internalStorage=window.localStorage||window.sessionStorage,null===this.internalStorage.getItem(this.key)&&this._saveList({})}d.prototype.get=function(t){return this._getList()[t]||null},d.prototype.set=function(t,e){var n=this._getList();r(document).trigger(o,[t,e,n]),n[t]=e,this._saveList(n)},d.prototype.unset=function(t){var e=this._getList();e[t],delete e[t],this._saveList(e)},d.prototype._getList=function(){return JSON.parse(this.internalStorage.getItem(this.key))},d.prototype._saveList=function(t){this.internalStorage.setItem(this.key,JSON.stringify(t))};function u(t){var e,n,o,i,r,s,a;M(t)&&(t=(e=b().editor).view,n=w(),i=L(n),o=I(n),i&&e.isEmpty()&&(i=e.view.state.tr.insert(0,e.parser.parse(i)),e.view.dispatch(i),v.commands.joinBackward(t.state,t.dispatch,t)),o&&setTimeout(function(){l.instance(".reply-container").attachReply(o)},500),e.on("keyup mouseup",(r=function(){var t=e.serializer.serialize(e.view.state.doc);h.set(n,t)},s=1e3,a=null,function(){a=a||setTimeout(function(){r(),a=null},s)})),e.$.on("clear",function(){h.unset(n)}))}function p(){g&&g.disconnect(),m&&r(document).off(o,m),y&&r(document).off(s,y),x=!1}var h,f,g,m,y,v,b=function(){return l.instance(r(e.messagesRoot).find(e.editor))},w=function(){return l.instance(e.messagesRoot).getActiveMessageId()},M=function(t){var n=[],o=!1;return r(t).each(function(t,e){e.addedNodes.length&&(n=n.concat(Array.from(e.addedNodes)))}),n.length&&r(n).each(function(t,e){if(r(e).is(".mail-conversation")||r(e).is(".mail-aside"))return o=!0}),o&&b()},x=!1,L=function(t){return h.get(t)},I=function(t){return f.get(t)};n.export({initOnPjaxLoad:!0,init:function(){if(!((t=a.getUrlParameter("r"))&&-1<decodeURIComponent(t).indexOf("mail/mail")||-1<location.pathname.indexOf("mail/mail")))return!!x&&p();x&&p();var t=r(e.messagesRoot);g=g||new MutationObserver(u);const i=w();v=c.prosemirror.api,h=new d("mail:conversation:drafts"),f=new d("mail:conversation:reply"),g.observe(t[0],{childList:!0,subtree:!0}),m=function(t,e){n.log.debug("Draft #"+e+" just changed")},r(document).on(o,m),y=function(t,e,n,o){""===n&&""===o?f.unset(i):f.set(i,e)},r(document).on(s,y),x=!0},DraftsStorage:h,ReplyStorage:f})}),humhub.module("mail.mobile",function(t,e,n){var o="mail-breadcrumbs",i=e("ui.widget").Widget,r=e("ui.view"),s=e("util").url,a=i.extend(),l=(a.prototype.getButton=function(){return n(this.anchor)},a.prototype.hideBackButton=function(){this.getButton().hide()},function(){n(document.body).toggleClass("rocket-mobile-body",r.isSmall()&&c())}),c=function(){var t=s.getUrlParameter("r");return t&&-1<decodeURIComponent(t).indexOf("mail/mail")||-1<location.pathname.indexOf("mail/mail")};t.export({init:function(){var t,e;(e=n(".mails-header")).length&&!n("#"+o).length&&((t=document.createElement("div")).id=o,t.dataset.uiWidget="mail.mobile.MailBreadcrumbs",e.append(t),i.instance(t)),c()?(n(window).on("resize",l),l()):n(window).off("resize",l)},MailBreadcrumbs:a,closeConversation:function(t){t&&t.preventDefault(),n(".messages").removeClass("shown"),a.prototype.hideBackButton()},closeConversationMobile:function(t){i.instance("#mail-conversation-root").close(t)}})}),humhub.module("mail.filter.unread",function(t,e,n){var o=t.require("ui.widget").Widget,e=e("ui.filter").Filter.extend();e.prototype.init=function(){this.cosmeticCheckbox=this.$.find("#rocketmailfilter-unread-toggle"),this.hiddenInput=this.$.find("[name=unread]"),this.inputContainer=this.cosmeticCheckbox.closest("#rocketmailfilter-root"),this.mailFilterForm=o.instance("#mail-filter-root").$.find("form"),this.placeUnreadCheckbox(),this.attachListeners()},e.prototype.placeUnreadCheckbox=function(){this.mailFilterForm.prepend(this.$.detach()),this.$.removeClass("hidden")},e.prototype.attachListeners=function(){var t=this;this.cosmeticCheckbox.on("change",function(){t.toggleInputValue(),t.isChecked()?t.activateHiddenInput():t.deactivateHiddenInput(),o.instance("#mail-filter-root").triggerChange(),o.instance("#mail-conversation-root").close()})},e.prototype.toggleInputValue=function(){this.hiddenInput.val(this.isChecked()?"1":"0")},e.prototype.isChecked=function(){return this.cosmeticCheckbox.prop("checked")},e.prototype.activateHiddenInput=function(){this.inputContainer.prepend(this.hiddenInput)},e.prototype.deactivateHiddenInput=function(){this.hiddenInput.remove()},t.export=e}),humhub.module("mail.UserList",function(n,t,o){function e(){const t=o(i.form);let e={};t&&(e=t.serializeArray()),r.global.post(n.config.userListUrl,{data:e})}const i={form:"#chat-user-list-form",filter:'input[name="UserFilter[filter]"]'},r=t("ui.modal"),s=t("client");n.export({filter:e,clear:function(){o(i.filter).val(""),r.global.post(n.config.userListUrl,{data:{}})},remove:function(t){s.get(n.config.removeParticipantUrl+(`?id=${t.params.conversationId}&userId=`+t.params.userId)).then(()=>{e()})}})});